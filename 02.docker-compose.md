## docker compose <img src ="./images/dockercompose01.png" width="80">

- Docker Compose는 여러 컨테이너를 실행하는 환경을 효율적으로 관리하는 도구
- 도커 테스크톱을 설치할 때 기본적으로 포함돼 있어 별도로 설치하지 않아도 바로 사용할 수 있습니다. 또한 한번의 명령어로 모든 컨테이너, 네트워크, 볼륨을 동시에 생성할 수 있으며 전체 환경을 한꺼번에 종료할 수 있습니다.

### 리눅스에 docker compose 설치

윈도우에서는 dockerDesktop 설치되어 있으면 바로 사용 가능함.

```sh
# Compose Plugin
sudo mkdir -p /usr/local/lib/docker/cli-plugins/
sudo curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-$(uname -m)" -o /usr/local/lib/docker/cli-plugins/docker-compose
sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
```

### [docker compose 명령어](https://docs.docker.com/reference/cli/docker/compose/)

```
docker compose up      <=  YAML 파일에 정의된 서비스 생성 및 시작  ( -d --build  <= 빌드한 후 백그라운드로 실행 )
docker compose ls      <=  현재 실행중인 서비스의 상태 표시
docker compose ps      <=  현재 실행중인 서비스의 컨테이너 상태 표시
docker compose start   <=  서비스에 대한 기존 컨테이너를 시작
docker compose stop    <=  실행중인 컨테이너를 삭제하지 않고 중지
docker compose logs    <=  실행중인 서비스의 로그 표시
docker compose down    <=  YAML 파일에 정의된 서비스 종료 및 제거
docker compose build   <=  서비스의 도커파일 또는 내용이 변경된 경우 이미지를 다시 빌드
```

### mysql

docker run 명령

```bash
# mysql 계정생성
mysql>create database edudb;
mysql>create user 'hr'@'%' identified by 'jdbctest';
mysql>grant all on edudb.* to 'hr'@'%';
mysql>flush privileges;

## sql 파일 실행
mysql> source \home\user\init.sql;

# 도커 컨테이너 실행
docker create volume vtest
docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=admin -v vtest:/var/lib/mysql --name mysql mysql:8.0
```

docker-compose.yml

```yml
services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: admin
      MYSQL_DATABASE: edudb
      MYSQL_USER: hr
      MYSQL_PASSWORD: hr
    command: --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
    ports:
      - "3306:3306"
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      - vmysql:/var/lib/mysql
volumes:
  vmysql:
```

/docker-entrypoint-initdb.d 폴더는 Docker에서 MySQL, PostgreSQL 등 데이터베이스 컨테이너가 최초 실행될 때 테이블 생성, 데이터 초기화 등의 SQL 문을 자동으로 실행하도록 설정하는 경로입니다. 사용자가 작성한 SQL 파일을 이 위치에 마운트하여 DB 초기 설정을 자동화합니다.

### mysql + springboot

`depends_on` 명령은 서비스간의 종속성 순서대로 서비스를 시작. mysql을 먼저 실행하고 나서 springboot를 실행

docker-compose.yml

```yml
services:
  mysql:
    image: mysql:8.0
    container_name: mysql-container
    ports:
      - "3306:3306"
    volumes:
      - vtest:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: admin
      MYSQL_DATABASE: edudb
      MYSQL_USER: jdbctest
      MYSQL_PASSWORD: jdbctest
    networks:
      - springboot-mysql-net

  springedu:
    image: cyannara/edu:latest
    container_name: springedu-container
    ports:
      - "81:9090"
    volumes:
      - fileupload-volume:/uploadtest
    depends_on:
      - mysql
    networks:
      - springboot-mysql-net

volumes:
  vtest:
  fileupload-volume:

networks:
  springboot-mysql-net:
    driver: bridge
```

### mysql + redmine

docker-compose.yml

```yml
services:
  redmine:
    image: redmine:5
    container_name: redmine
    restart: always
    ports:
      - "3000:3000"
    environment:
      REDMINE_DB_MYSQL: db
      REDMINE_DB_DATABASE: redmine
      REDMINE_DB_USERNAME: redmine
      REDMINE_DB_PASSWORD: redmine
      REDMINE_DB_ENCODING: utf8mb4
    volumes:
      - /data/redmine/files:/usr/src/redmine/files
      - /data/redmine/plugins:/usr/src/redmine/plugins
      - /data/redmine/themes:/usr/src/redmine/public/themes
    depends_on:
      - db

  db:
    image: mysql:8.0
    container_name: redmine-db
    restart: always
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: redmine
      MYSQL_USER: redmine
      MYSQL_PASSWORD: redmine
      TZ: Asia/Seoul
    volumes:
      - /data/mysql:/var/lib/mysql
    command:
      [
        "--default-authentication-plugin=mysql_native_password",
        "--character-set-server=utf8mb4",
        "--collation-server=utf8mb4_unicode_ci",
      ]
```
